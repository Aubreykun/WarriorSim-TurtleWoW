var SIM=SIM||{};SIM.SETTINGS={init:function(){this.variables(),this.events(),this.buildSpells(),this.buildBuffs(),this.buildTalents(),this.buildRunes()},variables:function(){this.body=$("body"),this.buffs=this.body.find("article.buffs"),this.fight=this.body.find("article.fight"),this.rotation=this.body.find("article.rotation"),this.talents=this.body.find("article.talents"),this.filter=this.body.find("article.filter"),this.close=this.body.find("section.settings .btn-close"),this.bg=this.body.find("section.sidebar .bg")},events:function(){var e=this;e.close.click(function(t){t.preventDefault(),$(".js-settings").removeClass("active"),$("section.settings").removeClass("active"),e.body.addClass("sidebar-mobile-open")}),e.buffs.on("click",".icon",function(t){let a=$(this).toggleClass("active");a.hasClass("active")&&(a.data("group")&&a.siblings().filter('[data-group="'+a.data("group")+'"]').removeClass("active"),a.data("disable-spell")&&$('.rotation [data-id="'+a.data("disable-spell")+'"]').removeClass("active"));for(let t of buffs)t.active=e.buffs.find('[data-id="'+t.id+'"]').hasClass("active");t.stopPropagation(),t.preventDefault(),SIM.UI.updateSession(),SIM.UI.updateSidebar()}),e.talents.on("click",".icon",function(t){let a=e.getTalent($(this));if(e.getTalentTotal($(this))<5*a.y)return;let i=JSON.parse(localStorage[mode+(globalThis.profileid||0)]),s=parseInt(i.level),l=0;for(let e of talents)for(let t of e.t)l+=t.c;Math.max(s-9-l,0)<=0||(a.c=a.c<a.m?a.c+1:a.m,$(this).attr("data-count",a.c),a.c>=a.m&&$(this).addClass("maxed"),a.enable&&$('.rotation [data-id="'+a.enable+'"]').removeClass("hidden"),$(this).find("a").attr("href","https://classic.wowhead.com/spell="+a.s[0==a.c?0:a.c-1]),SIM.UI.updateSession(),SIM.UI.updateSidebar(),e.buildSpells())}),e.talents.on("contextmenu",".icon",function(t){t.preventDefault();let a=e.getTalent($(this));if(a.c=a.c<1?0:a.c-1,$(this).attr("data-count",a.c),$(this).removeClass("maxed"),0==a.c&&a.enable){$('.rotation [data-id="'+a.enable+'"]').removeClass("active").addClass("hidden");for(let e of spells)e.id==a.enable&&(e.active=!1)}$(this).find("a").attr("href","https://classic.wowhead.com/spell="+a.s[0==a.c?0:a.c-1]),SIM.UI.updateSession(),SIM.UI.updateSidebar()}),e.talents.on("click",".js-talents-reset",function(t){t.preventDefault();for(let e of talents)for(let t of e.t)t.c=0;SIM.UI.updateSession(),SIM.UI.updateSidebar(),e.buildTalents(),e.buildSpells()}),e.filter.on("click",".sources > li",function(t){if($(this).toggleClass("active"),$(this).hasClass("active")){let t=$(this).data("id");e.filter.find(`.phases [data-sources*="${t}"]`).addClass("active")}SIM.UI.updateSession(),SIM.UI.filterGear(),t.preventDefault()}),e.filter.on("click",".js-toggle, li ul",function(e){if(e.stopPropagation(),this.classList.contains("js-toggle")){var t=this.getAttribute("data-id");$("."+t).toggleClass("hidden")}}),e.filter.on("click",".phases li",function(t){$(this).toggleClass("active");let a=$(this).data("sources").split(","),i=$(this).hasClass("active");for(let t of a)i?e.filter.find('.sources [data-id="'+t+'"]').addClass("active"):e.filter.find('.sources [data-id="'+t+'"]').removeClass("active");SIM.UI.updateSession(),SIM.UI.filterGear()}),e.buffs.on("click","label",function(e){$(this.parentElement).find("div").toggleClass("hidden"),SIM.SETTINGS.toggleArticle(this)}),e.fight.on("click","label",function(e){$(this.parentElement).find("ul").toggleClass("hidden"),SIM.SETTINGS.toggleArticle(this)}),e.talents.on("click","label",function(e){$(this.parentElement).find("table").toggleClass("hidden"),SIM.SETTINGS.toggleArticle(this)}),e.filter.on("click","label",function(e){$(this.parentElement).find("ul").toggleClass("hidden"),SIM.SETTINGS.toggleArticle(this)}),e.fight.on("input",".slider",function(e){var t=$(this).val();$(this).next().val(t),$(this).next().trigger("keyup")}),e.fight.on("change",'select[name="race"]',function(t){var a=$(this).val();e.bg.attr("data-race",a),t.stopPropagation(),SIM.UI.updateSession(),SIM.UI.updateSidebar(),e.buildSpells()}),e.fight.on("change",'select[name="aqbooks"]',function(e){e.stopPropagation(),SIM.UI.updateSession(),SIM.UI.updateSidebar()}),e.fight.on("keyup",'input[type="text"]',function(t){t.stopPropagation(),e.body.find('.active[data-type="profiles"]').length||SIM.UI.filterGear(),SIM.UI.updateSession(),SIM.UI.updateSidebar(),e.buildBuffs(),e.buildSpells()}),e.fight.on("change",'select[name="batching"]',function(e){e.stopPropagation(),SIM.UI.updateSession(),SIM.UI.updateSidebar()}),e.rotation.on("click",".spell a",function(t){t.stopPropagation(),t.preventDefault();let a=$(this).closest(".spell"),i=a.data("id");a.toggleClass("open"),a.removeClass("fade");let s=a.hasClass("open");s?(a.siblings().addClass("fade"),a.siblings(".open").each(function(){$(this).removeClass("open"),e.hideSpellDetails($(this))})):a.siblings().removeClass("fade");for(let t of spells)t.id==i&&(s?e.buildSpellDetails(t,a):e.hideSpellDetails(a))}),e.rotation.on("click",".details li:not(.nobox)",function(t){if("LI"!==t.target.nodeName)return;$(this).toggleClass("active");let a=$(this).hasClass("active"),i=$(this).parents(".details").data("id");"active"==$(this).data("id")&&e.rotation.find(`.spell[data-id="${i}"]`).toggleClass("active",a),a&&$(this).data("group")&&$(this).siblings(`.active[data-group="${$(this).data("group")}"]`).click();for(let e of spells)e.id==i&&(e[$(this).data("id")]=a);SIM.UI.updateSession()}),e.rotation.on("keyup",".details input",function(e){let t=$(this).parents(".details").data("id");for(let e of spells)e.id==t&&(e[$(this).attr("name")]=$(this).val());SIM.UI.updateSession()})},buildSpells:function(){let e=JSON.parse(localStorage[mode+(globalThis.profileid||0)]),t=parseInt(e.level),a=this.rotation.find("div:first");a.empty(),this.rotation.find(".open")&&this.hideSpellDetails(this.rotation.find(".open"));let i="";for(let s of spells){if(26296==s.id&&"Troll"!==e.race){s.active=!1;continue}if(20572==s.id&&"Orc"!==e.race){s.active=!1;continue}let l,n,o=parseInt(s.minlevel||0),d=parseInt(s.maxlevel||60);if(t<o||t>d){s.active=!1;continue}for(let e of talents)for(let t of e.t)t.n==s.name&&(l=t);if(l&&l.enable&&0==l.c){s.active=!1;continue}if("undefined"!=typeof runes){for(let e in runes)for(let t of runes[e])t.enable==s.id&&(n=t);if(n&&!n.selected){s.active=!1;continue}}else if(s.rune){s.active=!1;continue}let c=$(`<div data-id="${s.id}" class="spell ${s.active?"active":""}"><div class="icon">\n            <img src="dist/img/${s.iconname.toLowerCase()}.jpg " alt="${s.name}">\n            <a href="https://classic.wowhead.com/spell=${s.id}" class="wh-tooltip"></a>\n            </div></div>`);s.buff?i+=c[0].outerHTML:a.append(c)}a.append($('<div class="label">Buffs</div>')),a.append(i)},buildSpellDetails(e,t){let a=this.rotation.find(".details");a.data("id",e.id),a.empty(),a.append(`<label>${e.name}</label>`);let i=$("<ul></ul>");void 0!==e.haste&&i.append(`<li class="nobox ${e.haste?"active":""}">Attack speed set at <input type="text" name="haste" value="${e.haste}" data-numberonly="true" /> %</li>`),void 0===e.timetoend&&i.append(`<li data-id="active" class="${e.active?"active":""}">Enabled</li>`),void 0!==e.minrage&&11597!=e.id&&i.append(`<li data-id="minrageactive" class="${e.minrageactive?"active":""}">${"Heroic Strike"==e.name?"Queue":"Use"} when above <input type="text" name="minrage" value="${e.minrage}" data-numberonly="true" /> rage</li>`),void 0!==e.minrage&&11597==e.id&&i.append(`<li data-id="minrageactive" class="${e.minrageactive?"active":""}" data-group="usage">Only use when above <input type="text" name="minrage" value="${e.minrage}" data-numberonly="true" /> rage</li>`),void 0!==e.maxrage&&i.append(`<li data-id="maxrageactive" class="${e.maxrageactive?"active":""}">Don't use when above <input type="text" name="maxrage" value="${e.maxrage}" data-numberonly="true" /> rage</li>`),void 0!==e.maincd&&i.append(`<li data-id="maincdactive" class="${e.maincdactive?"active":""}">Don't ${"Heroic Strike"==e.name?"queue":"use"} if BT / MS cooldown shorter than <input type="text" name="maincd" value="${e.maincd}" data-numberonly="true" /> seconds</li>`),void 0!==e.duration&&i.append(`<li data-id="durationactive" class="${e.durationactive?"active":""}" data-group="usage">Only use every <input type="text" name="duration" value="${e.duration}" data-numberonly="true" /> seconds</li>`),void 0!==e.unqueue&&i.append(`<li data-id="unqueueactive" class="${e.unqueueactive?"active":""}">Unqueue if below <input type="text" name="unqueue" value="${e.unqueue}" data-numberonly="true" /> rage before MH swing</li>`),void 0!==e.exmacro&&i.append(`<li data-id="exmacro" class="${e.exmacro?"active":""}" data-group="ex">Always queue when casting Execute</li>`),void 0!==e.timetoend&&i.append(`<li data-id="active" class="${e.active?"active":""}">Use on last <input type="text" name="timetoend" value="${e.timetoend}" data-numberonly="true" /> seconds of the fight</li>`),void 0!==e.priorityap&&i.append(`<li data-id="priorityapactive" class="${e.priorityapactive?"active":""}">Don't use if Attack Power is higher than <input type="text" name="priorityap" value="${e.priorityap}" data-numberonly="true" style="width: 25px" /></li>`),void 0!==e.procblock&&i.append(`<li data-id="procblock" class="${e.procblock?"active":""}">Don't use rage until it procs</li>`),void 0!==e.rageblock&&i.append(`<li data-id="rageblockactive" class="${e.rageblockactive?"active":""}">Don't use rage below <input type="text" name="rageblock" value="${e.rageblock}" data-numberonly="true" /> rage</li>`),void 0!==e.flagellation&&i.append(`<li data-id="flagellation" class="${e.flagellation?"active":""}">Don't use when ${18499==e.id?"Bloodrage":"Berserker Rage"} is up</li>`),void 0!==e.consumedrage&&i.append(`<li data-id="consumedrage" class="${e.consumedrage?"active":""}">Use only when Consumed by Rage procs</li>`),void 0!==e.execute&&i.append(`<li data-id="execute" class="${e.execute?"active":""}">Use during Execute phase</li>`),void 0!==e.globals&&i.append(`<li data-id="globalsactive" class="${e.globalsactive?"active":""}" data-group="usage">Only use on first <input type="text" name="globals" value="${e.globals}" data-numberonly="true" /> globals</li>`),a.css("visibility","hidden"),a.append(i);let s=a.height();setTimeout(function(){a.css("visibility",""),t.css("margin-bottom",s+30+"px"),a.css("top",t.position().top+74+"px"),a.addClass("visible")},200)},hideSpellDetails(e){this.rotation.find(".details").removeClass("visible"),e.css("margin-bottom","0px")},toggleArticle:function(e){e.classList.contains("active")?(e.classList.add("inactive"),e.classList.remove("active")):(e.classList.add("active"),e.classList.remove("inactive"))},buildBuffs:function(){this.buffs.empty(),this.buffs.append('<label class="active">Buffs</label>');let e=JSON.parse(localStorage[mode+(globalThis.profileid||0)]),t=parseInt(e.level),a="",i="",s="";for(let e of buffs){let l=parseInt(e.minlevel||0),n=parseInt(e.maxlevel||60);if(t<l||t>n){e.active=!1;continue}let o=e.spellid?"spell":"item",d=e.active?"active":"",c=e.group?`data-group="${e.group}"`:"",r=e.disableSpell?`data-disable-spell="${e.disableSpell}"`:"",p=`<div data-id="${e.id}" class="icon ${d}" ${c} ${r}>\n                            <img src="dist/img/${e.iconname.toLowerCase()}.jpg " alt="${e.name}">\n                            <a href="https://classic.wowhead.com/${o}=${e.id}" class="wh-tooltip"></a>\n                        </div>`;e.worldbuff?a+=p:e.consume?i+=p:e.other?s+=p:this.buffs.append(p)}this.buffs.append('<div class="label">Consumables</div>'),this.buffs.append(i),this.buffs.append('<div class="label">World Buffs</div>'),this.buffs.append(a),this.buffs.append('<div class="label">Other</div>'),this.buffs.append(s),SIM.UI.updateSession(),SIM.UI.updateSidebar()},buildTalents:function(){this.talents.find("table").remove();for(let e of talents){let t=$('<table><tr><th colspan="4">'+e.n+"</th></tr></table>");for(let e=0;e<7;e++)t.prepend("<tr><td></td><td></td><td></td><td></td></tr>");for(let a of e.t){let e=$('<div class="icon" data-count="'+a.c+'" data-x="'+a.x+'" data-y="'+a.y+'"></div>');e.html('<img src="dist/img/'+a.iconname.toLowerCase()+'.jpg" alt="'+a.n+'" />'),a.c>=a.m&&e.addClass("maxed"),e.append('<a href="https://classic.wowhead.com/spell='+a.s[0==a.c?0:a.c-1]+'" class="wh-tooltip"></a>'),t.find("tr").eq(a.y).children().eq(a.x).append(e)}this.talents.append(t)}},buildRunes:function(){if("undefined"!=typeof runes)for(let e in runes)for(let t in runes[e]){let a=runes[e][t];a.enable&&a.selected&&this.rotation.find('[data-id="'+a.enable+'"]').removeClass("hidden"),a.enable&&!a.selected&&this.rotation.find('[data-id="'+a.enable+'"]').addClass("hidden")}},getTalent:function(e){let t=e.parents("table").index()-1,a=e.data("x"),i=e.data("y");for(let e of talents[t-1].t)if(e.x==a&&e.y==i)return e},getTalentTotal:function(e){let t=e.parents("table").index()-1,a=0;for(let e of talents[t-1].t)a+=parseInt(e.c);return a}};