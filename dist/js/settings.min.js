var SIM=SIM||{};SIM.SETTINGS={init:function(){this.variables(),this.events(),this.buildSpells(),this.buildBuffs(),this.buildTalents(),this.buildRunes()},variables:function(){this.body=$("body"),this.buffs=this.body.find("article.buffs"),this.fight=this.body.find("article.fight"),this.rotation=this.body.find("article.rotation"),this.talents=this.body.find("article.talents"),this.filter=this.body.find("article.filter"),this.runes=this.body.find("article.runes"),this.close=this.body.find("section.settings .btn-close"),this.bg=this.body.find("section.sidebar .bg")},events:function(){var e=this;e.close.click(function(t){t.preventDefault(),$(".js-settings").removeClass("active"),$("section.settings").removeClass("active"),e.body.addClass("sidebar-mobile-open")}),e.buffs.on("click",".icon",function(t){let a=$(this).toggleClass("active");a.hasClass("active")&&(a.data("group")&&a.siblings().filter('[data-group="'+a.data("group")+'"]').removeClass("active"),a.data("disable-spell")&&$('.rotation [data-id="'+a.data("disable-spell")+'"]').removeClass("active"));for(let t of buffs)t.active=e.buffs.find('[data-id="'+t.id+'"]').hasClass("active");t.stopPropagation(),t.preventDefault(),SIM.UI.updateSession(),SIM.UI.updateSidebar()}),e.talents.on("click",".icon",function(t){let a=e.getTalent($(this)),i=(e.getTalentTotal($(this)),JSON.parse(localStorage[mode+(globalThis.profileid||0)])),l=parseInt(i.level),s=0;for(let e of talents)for(let t of e.t)s+=t.c;Math.max(l-9-s,0);a.c=a.c<a.m?a.c+1:a.m,$(this).attr("data-count",a.c),a.c>=a.m&&$(this).addClass("maxed"),a.enable&&$('.rotation [data-id="'+a.enable+'"]').removeClass("hidden"),a.enablename&&$('.rotation [data-name="'+a.enablename+'"]').removeClass("hidden"),$(this).find("a").attr("href",WEB_DB_URL+"spell="+a.s[0==a.c?0:a.c-1]),SIM.UI.updateSession(),SIM.UI.updateSidebar(),e.buildSpells()}),e.talents.on("contextmenu",".icon",function(t){t.preventDefault();let a=e.getTalent($(this));if(a.c=a.c<1?0:a.c-1,$(this).attr("data-count",a.c),$(this).removeClass("maxed"),0==a.c&&a.enable){$('.rotation [data-id="'+a.enable+'"]').removeClass("active").addClass("hidden");for(let e of spells)e.id==a.enable&&(e.active=!1)}if(0==a.c&&a.enablename){$('.rotation [data-name="'+a.enablename+'"]').removeClass("active").addClass("hidden");for(let e of spells)e.name==a.enablename&&(e.active=!1)}$(this).find("a").attr("href",WEB_DB_URL+"spell="+a.s[0==a.c?0:a.c-1]),SIM.UI.updateSession(),SIM.UI.updateSidebar()}),e.talents.on("click",".js-talents-reset",function(t){t.preventDefault();for(let e of talents)for(let t of e.t)t.c=0;SIM.UI.updateSession(),SIM.UI.updateSidebar(),e.buildTalents(),e.buildSpells()}),e.filter.on("click",".sources > li",function(e){$(this).toggleClass("active"),SIM.UI.updateSession(),SIM.UI.filterGear(),e.preventDefault()}),e.filter.on("click",".js-toggle, li ul",function(e){if(e.stopPropagation(),this.classList.contains("js-toggle")){var t=this.getAttribute("data-id");$("."+t).toggleClass("hidden")}}),e.filter.on("click",".phases li",function(t){$(this).toggleClass("active");let a=$(this).data("sources").split(","),i=$(this).hasClass("active");for(let t of a)i?e.filter.find('.sources [data-id="'+t+'"]').addClass("active"):e.filter.find('.sources [data-id="'+t+'"]').removeClass("active");SIM.UI.updateSession(),SIM.UI.filterGear()}),e.buffs.on("click","label",function(e){$(this.parentElement).find("div").toggleClass("hidden"),SIM.SETTINGS.toggleArticle(this)}),e.rotation.on("click","label",function(e){$(this.parentElement).find("div").toggleClass("hidden"),SIM.SETTINGS.toggleArticle(this)}),e.fight.on("click","label",function(e){$(this.parentElement).find("ul").toggleClass("hidden"),SIM.SETTINGS.toggleArticle(this)}),e.talents.on("click","label",function(e){$(this.parentElement).find("table").toggleClass("hidden").end().find("#top").toggleClass("hidden top"),SIM.SETTINGS.toggleArticle(this)}),e.runes.on("click","label",function(e){$(this.parentElement).find("div").toggleClass("hidden"),SIM.SETTINGS.toggleArticle(this)}),e.filter.on("click","label",function(e){$(this.parentElement).find("ul").toggleClass("hidden"),SIM.SETTINGS.toggleArticle(this)}),e.fight.on("input",".slider",function(e){var t=$(this).val();$(this).next().val(t),$(this).next().trigger("keyup")}),e.fight.on("change",'select[name="race"]',function(t){var a=$(this).val();e.bg.attr("data-race",a),t.stopPropagation(),SIM.UI.updateSession(),SIM.UI.updateSidebar(),e.buildSpells()}),e.fight.on("change",'select[name="aqbooks"]',function(t){t.stopPropagation(),SIM.UI.updateSession(),SIM.UI.updateSidebar(),e.buildSpells(),e.buildBuffs()}),e.fight.on("keyup",'input[type="text"]',function(t){t.stopPropagation(),e.body.find('.active[data-type="profiles"]').length||SIM.UI.filterGear(),SIM.UI.updateSession(),SIM.UI.updateSidebar(),e.buildBuffs(),e.buildSpells()}),e.fight.on("change",'select[name="batching"]',function(e){e.stopPropagation(),SIM.UI.updateSession(),SIM.UI.updateSidebar()}),e.rotation.on("click",".spell a",function(t){t.stopPropagation(),t.preventDefault();let a=$(this).closest(".spell"),i=a.data("id");a.toggleClass("open"),a.removeClass("fade");let l=a.hasClass("open");l?(a.siblings().addClass("fade"),a.siblings(".open").each(function(){$(this).removeClass("open"),e.hideSpellDetails($(this))})):a.siblings().removeClass("fade");for(let t of spells)t.id==i&&(l?e.buildSpellDetails(t,a):e.hideSpellDetails(a))}),e.rotation.on("click",".details li:not(.nobox)",function(t){if("LI"!==t.target.nodeName)return;$(this).toggleClass("active");let a,i=$(this).hasClass("active"),l=$(this).parents(".details").data("id");for(let e of spells)e.id==l&&(a=e);if("active"==$(this).data("id")){if(e.rotation.find(`.spell[data-id="${l}"]`).toggleClass("active",i),i&&"Heroic Strike"==a.name)for(let t of spells)"Cleave"==t.name&&t.active&&(t.active=!1,e.rotation.find(`.spell[data-id="${t.id}"]`).removeClass("active"));if(i&&"Cleave"==a.name)for(let t of spells)"Heroic Strike"==t.name&&t.active&&(t.active=!1,e.rotation.find(`.spell[data-id="${t.id}"]`).removeClass("active"))}i&&$(this).data("group")&&$(this).siblings(`.active[data-group="${$(this).data("group")}"]`).click(),a[$(this).data("id")]=i,SIM.UI.updateSession()}),e.rotation.on("keyup",".details input",function(e){let t=$(this).parents(".details").data("id");for(let e of spells)e.id==t&&(e[$(this).attr("name")]=$(this).val());SIM.UI.updateSession()})},buildSpells:function(){let e=JSON.parse(localStorage[mode+(globalThis.profileid||0)]),t=parseInt(e.level),a=this.rotation.find("div:first");a.empty(),this.rotation.find(".open")&&this.hideSpellDetails(this.rotation.find(".open"));let i="";for(let l of spells){if(26296==l.id&&"Troll"!==e.race){l.active=!1;continue}if(20572==l.id&&"Orc"!==e.race){l.active=!1;continue}let s,n,o=parseInt(l.minlevel||0),d=parseInt(l.maxlevel||60);if(t<o||t>d){l.active=!1;continue}for(let e of talents)for(let t of e.t)t.n==l.name&&(s=t);if(s&&s.enable&&0==s.c){l.active=!1;continue}if("undefined"!=typeof runes){for(let e in runes)for(let t of runes[e])t.enable==l.id&&(n=t);if(n&&!n.selected){l.active=!1;continue}}else if(l.rune){l.active=!1;continue}if(0==e.adjacent&&"Cleave"==l.name){l.active=!1;continue}if("Yes"==e.aqbooks&&void 0!==l.aq&&!1===l.aq){l.active=!1;continue}if("No"==e.aqbooks&&l.aq){l.active=!1;continue}let c=$(`<div data-id="${l.id}" data-name="${l.name}" class="spell ${l.active?"active":""}"><div class="icon">\n            <img src="dist/img/${l.iconname.toLowerCase()}.jpg " alt="${l.name}">\n            <a href="${WEB_DB_URL}spell=${l.id}" class="wh-tooltip"></a>\n            </div></div>`);l.buff?i+=c[0].outerHTML:a.append(c)}a.append($('<div class="label">Buffs</div>')),a.append(i)},buildSpellDetails(e,t){let a=this.rotation.find(".details");a.data("id",e.id),a.empty(),a.append(`<label>${e.name}</label>`);let i=$("<ul></ul>");void 0!==e.haste&&i.append(`<li class="nobox ${e.haste?"active":""}">Attack speed set at <input type="text" name="haste" value="${e.haste}" data-numberonly="true" /> %</li>`),void 0===e.timetoend&&i.append(`<li data-id="active" class="${e.active?"active":""}">Enabled</li>`),void 0!==e.minrage&&11597!=e.id&&i.append(`<li data-id="minrageactive" class="${e.minrageactive?"active":""}">${"Heroic Strike"==e.name?"Queue":"Use"} when above <input type="text" name="minrage" value="${e.minrage}" data-numberonly="true" /> rage</li>`),void 0!==e.minrage&&11597==e.id&&i.append(`<li data-id="minrageactive" class="${e.minrageactive?"active":""}" data-group="usage">Only use when above <input type="text" name="minrage" value="${e.minrage}" data-numberonly="true" /> rage</li>`),void 0!==e.maxrage&&i.append(`<li data-id="maxrageactive" class="${e.maxrageactive?"active":""}">Don't use when above <input type="text" name="maxrage" value="${e.maxrage}" data-numberonly="true" /> rage</li>`),void 0!==e.maincd&&i.append(`<li data-id="maincdactive" class="${e.maincdactive?"active":""}">Don't ${"Heroic Strike"==e.name?"queue":"use"} if BT / MS cooldown shorter than <input type="text" name="maincd" value="${e.maincd}" data-numberonly="true" /> seconds</li>`),void 0!==e.duration&&i.append(`<li data-id="durationactive" class="${e.durationactive?"active":""}" data-group="usage">Only use every <input type="text" name="duration" value="${e.duration}" data-numberonly="true" /> seconds</li>`),void 0!==e.unqueue&&i.append(`<li data-id="unqueueactive" class="${e.unqueueactive?"active":""}">Unqueue if below <input type="text" name="unqueue" value="${e.unqueue}" data-numberonly="true" /> rage before MH swing</li>`),void 0!==e.exmacro&&i.append(`<li data-id="exmacro" class="${e.exmacro?"active":""}" data-group="ex">Always queue when casting Execute</li>`),void 0!==e.decisive&&i.append(`<li data-id="decisive" class="${e.decisive?"active":""}">Use Decisive Strike Instead</li>`),void 0!==e.timetoend&&i.append(`<li data-id="active" class="${e.active?"active":""}">Use on last <input type="text" name="timetoend" value="${e.timetoend}" data-numberonly="true" /> seconds of the fight</li>`),void 0!==e.priorityap&&i.append(`<li data-id="priorityapactive" class="${e.priorityapactive?"active":""}">Don't use if Attack Power is higher than <input type="text" name="priorityap" value="${e.priorityap}" data-numberonly="true" style="width: 25px" /></li>`),void 0!==e.procblock&&i.append(`<li data-id="procblock" class="${e.procblock?"active":""}">Don't use rage until it procs</li>`),void 0!==e.rageblock&&i.append(`<li data-id="rageblockactive" class="${e.rageblockactive?"active":""}">Don't use rage below <input type="text" name="rageblock" value="${e.rageblock}" data-numberonly="true" /> rage</li>`),void 0!==e.flagellation&&i.append(`<li data-id="flagellation" class="${e.flagellation?"active":""}">Don't use when ${18499==e.id?"Bloodrage":"Berserker Rage"} is up</li>`),void 0!==e.consumedrage&&i.append(`<li data-id="consumedrage" class="${e.consumedrage?"active":""}">Use only when Consumed by Rage procs</li>`),void 0!==e.execute&&i.append(`<li data-id="execute" class="${e.execute?"active":""}">Use during Execute phase</li>`),void 0!==e.globals&&i.append(`<li data-id="globalsactive" class="${e.globalsactive?"active":""}" data-group="usage">Only use on first <input type="text" name="globals" value="${e.globals}" data-numberonly="true" /> globals</li>`),void 0!==e.chargeblock&&i.append(`<li data-id="chargeblockactive" class="${e.chargeblockactive?"active":""}">Don't use rage below <input type="text" name="chargeblock" value="${e.chargeblock}" data-numberonly="true" /> CbR charges</li>`),void 0!==e.erageblock&&i.append(`<div class="label">Execute Phase:</div><li data-id="erageblockactive" class="${e.erageblockactive?"active":""}">Don't use rage below <input type="text" name="erageblock" value="${e.erageblock}" data-numberonly="true" /> rage</li>`),void 0!==e.echargeblock&&i.append(`<li data-id="echargeblockactive" class="${e.echargeblockactive?"active":""}">Don't use rage below <input type="text" name="echargeblock" value="${e.echargeblock}" data-numberonly="true" /> CbR charges</li>`),a.css("visibility","hidden"),a.append(i);let l=a.height();setTimeout(function(){a.css("visibility",""),t.css("margin-bottom",l+30+"px"),a.css("top",t.position().top+74+"px"),a.addClass("visible")},200)},hideSpellDetails(e){this.rotation.find(".details").removeClass("visible"),e.css("margin-bottom","0px")},toggleArticle:function(e){e.classList.contains("active")?(e.classList.add("inactive"),e.classList.remove("active")):(e.classList.add("active"),e.classList.remove("inactive"))},buildBuffs:function(){this.buffs.empty(),this.buffs.append('<label class="active">Buffs</label>');let e=JSON.parse(localStorage[mode+(globalThis.profileid||0)]),t=parseInt(e.level),a="",i="",l="";for(let s of buffs){let n=parseInt(s.minlevel||0),o=parseInt(s.maxlevel||60);if(t<n||t>o){s.active=!1;continue}if("Yes"==e.aqbooks&&void 0!==s.aq&&!1===s.aq){s.active=!1;continue}if("No"==e.aqbooks&&s.aq){s.active=!1;continue}if("sod"!==mode&&s.sod){s.active=!1;continue}let d=s.spellid?"spell":"item",c=s.active?"active":"",r=s.group?`data-group="${s.group}"`:"",p=s.disableSpell?`data-disable-spell="${s.disableSpell}"`:"",u=`<div data-id="${s.id}" class="icon ${c}" ${r} ${p}>\n                            <img src="dist/img/${s.iconname.toLowerCase()}.jpg " alt="${s.name}">\n                            <a href="${WEB_DB_URL}${d}=${s.id}" class="wh-tooltip"></a>\n                        </div>`;s.worldbuff?a+=u:s.consume?i+=u:s.other?l+=u:this.buffs.append(u)}this.buffs.append('<div class="label">Consumables</div>'),this.buffs.append(i),this.buffs.append('<div class="label">World Buffs</div>'),this.buffs.append(a),this.buffs.append('<div class="label">Other</div>'),this.buffs.append(l),SIM.UI.updateSession(),SIM.UI.updateSidebar()},buildTalents:function(){this.talents.find("table").remove();for(let e of talents){let t=$('<table><tr><th colspan="4">'+e.n+"</th></tr></table>");for(let e=0;e<7;e++)t.prepend("<tr><td></td><td></td><td></td><td></td></tr>");for(let a of e.t){let e=$('<div class="icon" data-count="'+a.c+'" data-x="'+a.x+'" data-y="'+a.y+'"></div>');e.html('<img src="dist/img/'+a.iconname.toLowerCase()+'.jpg" alt="'+a.n+'" />'),a.c>=a.m&&e.addClass("maxed"),e.append(`<a href="${WEB_DB_URL}spell=`+a.s[0==a.c?0:a.c-1]+'" class="wh-tooltip"></a>'),t.find("tr").eq(a.y).children().eq(a.x).append(e)}this.talents.append(t)}},buildRunes:function(){if("undefined"!=typeof runes){this.runes.find("#runes-area").empty();for(let e in runes)for(let t in runes[e]){let a=runes[e][t];a.enable&&a.selected&&this.rotation.find('[data-id="'+a.enable+'"]').removeClass("hidden"),a.enable&&!a.selected&&this.rotation.find('[data-id="'+a.enable+'"]').addClass("hidden")}var e=$("nav > ul > li").map(function(){return $(this).data("type")}).get();for(let t of e)if(runes.hasOwnProperty(t)){let e=$("<table>"),a=$("<tbody>"),i=$(`<tr name="${t}">`);for(let e=0;e<runes[t].length;e++){let a=runes[t][e],l=$("<td>"),s=$(`<div data-id="${a.id}" class="rune"></div>`),n=$(`<div class="icon ${a.selected?"active":""}"></div>`);n.html(`<img src="dist/img/${a.iconname}.jpg" alt="${a.name}" />`),n.append(`<a href="${WEB_DB_URL}spell=${a.id}" class="wh-tooltip"></a>`),s.append(n),l.append(s),i.append(l)}let l=$("<tr>"),s=$(`<th colspawn="5">${t.toString().charAt(0).toUpperCase()}${t.slice(1).toString()}</th>`);l.append(s),e.append(l).append(i),a.append(e),this.runes.find("#runes-area").append(a)}else;}},getTalent:function(e){let t=e.parents("table").index()-1,a=e.data("x"),i=e.data("y");for(let e of talents[t-1].t)if(e.x==a&&e.y==i)return e},getTalentTotal:function(e){let t=e.parents("table").index()-1,a=0;for(let e of talents[t-1].t)a+=parseInt(e.c);return a}};